

<!DOCTYPE html>
<html lang="en" >



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/YXY.png">
  <link rel="icon" href="/img/YXY.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#c30000">
  <meta name="author" content="Xiyuan Yang">
  <meta name="keywords" content="Code">
  
    <meta name="description" content="This blog explains the basic concepts related to Python threads, including GIL, multithreading, multiprocessing, and asynchronous programming.">
<meta property="og:type" content="article">
<meta property="og:title" content="Python Threadings">
<meta property="og:url" content="https://xiyuanyang-code.github.io/posts/Python-Threadings/index.html">
<meta property="og:site_name" content="Xiyuan Yang&#39;s Blog">
<meta property="og:description" content="This blog explains the basic concepts related to Python threads, including GIL, multithreading, multiprocessing, and asynchronous programming.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://xiyuanyang-code.github.io/img/cover/gil.jpg">
<meta property="article:published_time" content="2025-05-01T14:58:27.000Z">
<meta property="article:modified_time" content="2025-05-02T09:25:20.583Z">
<meta property="article:author" content="Xiyuan Yang">
<meta property="article:tag" content="Finished">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Tutorial">
<meta property="article:tag" content="GIL">
<meta property="article:tag" content="Threadings">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://xiyuanyang-code.github.io/img/cover/gil.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Python Threadings - Xiyuan Yang&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xiyuanyang-code.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"❡"},"progressbar":{"enable":true,"height_px":3,"color":"red","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"L7r0uGb0fafbzNvmBADCMH42-gzGzoHsz","app_key":"2Lr1fQ2rjhwRiUrDx0VOQyUm","server_url":null,"path":"window.location.pathname","ignore_local":true},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Xiyuan Yang&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/above/" target="_self">
                <i class="iconfont icon-bookmark-fill"></i>
                <span>Intro</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archive</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Category</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tag</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="https://xiyuanyang-code.github.io/My-Resume/" target="_self">
                <i class="iconfont icon-code"></i>
                <span>Resume</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-books"></i>
                <span>Else</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/FAQ/" target="_self">
                    <i class="iconfont icon-bug"></i>
                    <span>FAQ</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/links" target="_self">
                    <i class="iconfont icon-link-fill"></i>
                    <span>Links</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/All-posts/" target="_self">
                    <i class="iconfont icon-notebook"></i>
                    <span>All-posts</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/Recordings/" target="_self">
                    <i class="iconfont icon-clipcheck"></i>
                    <span>recordings</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/resume/" target="_self">
                    <i class="iconfont icon-github-fill"></i>
                    <span>Github Introduction</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://github.com/xiyuanyang-code" target="_self">
                    <i class="iconfont icon-github-fill"></i>
                    <span>My Github</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/" target="_self">
                    <i class="iconfont icon-copyright"></i>
                    <span>About Hexo</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://xiyuanyang-code.github.io/posts/Life-musings/" target="_self">
                    <i class="iconfont icon-brush"></i>
                    <span>Life Musing</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/place.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Python Threadings"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Xiyuan Yang
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-01 22:58" pubdate>
          May 1, 2025 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.6k words
        
      </span>
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Project"
        id="heading-9e727fdd3aec8274f46685441900280d" role="tab" data-toggle="collapse" href="#collapse-9e727fdd3aec8274f46685441900280d"
        aria-expanded="true"
      >
        Project
        <span class="list-group-count">(8)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-9e727fdd3aec8274f46685441900280d"
           role="tabpanel" aria-labelledby="heading-9e727fdd3aec8274f46685441900280d">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/posts/MYGITHUB-Lightweight-speech-recognition-conversion-model/" title="MYGITHUB-Lightweight-Speech-Recognition-Conversion-Model"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">MYGITHUB-Lightweight-Speech-Recognition-Conversion-Model</span>
        </a>
      
    
      
      
        <a href="/posts/Python-numpy-cheatsheet/" title="Python-Numpy-Cheatsheet"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python-Numpy-Cheatsheet</span>
        </a>
      
    
      
      
        <a href="/posts/RAG-Blog-Content-Retrieval/" title="RAG-Blog-Content-Retrieval"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">RAG-Blog-Content-Retrieval</span>
        </a>
      
    
      
      
        <a href="/posts/Blog-Update-Fetching-Script/" title="Blog-Update-Fetching-Script"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Blog-Update-Fetching-Script</span>
        </a>
      
    
      
      
        <a href="/posts/CamelAI-automatic-essay-modification/" title="CamelAI-Automatic-Essay-Modification"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">CamelAI-Automatic-Essay-Modification</span>
        </a>
      
    
      
      
        <a href="/posts/My-Multi-Agents/" title="My Multi-Agents"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">My Multi-Agents</span>
        </a>
      
    
      
      
        <a href="/posts/Blog-Word-Counter/" title="Blog Word Counter"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Blog Word Counter</span>
        </a>
      
    
      
      
        <a href="/posts/Python-Threadings/" title="Python Threadings"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">Python Threadings</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Python Threadings</h1>
            
            
              <div class="markdown-body">
                
                <style>
  html, body, .markdown-body {
    font-family: Georgia, sans, serif;
  }
</style>

<h1 id="Threads-and-Processes-in-Python"><a href="#Threads-and-Processes-in-Python" class="headerlink" title="Threads and Processes in Python"></a>Threads and Processes in Python</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="线程和进程"><a href="#线程和进程" class="headerlink" title="线程和进程"></a>线程和进程</h3><ul>
<li><strong>线程</strong>（Threading）：操作系统进行计算和调度的最小单位，每一个线程都有对应的上下文。</li>
<li><strong>进程</strong>（Processing）：由若干个线程组成，这些线程可以享有这个进程的内存（<strong>变量共享</strong>）<ul>
<li><strong>进程是程序的执行实例</strong>，是操作系统分配资源（CPU、内存、文件句柄等）的基本单位。</li>
<li>每个进程有 <strong>独立的内存空间</strong>，进程间数据隔离（默认不共享变量）。</li>
<li>进程间通信（IPC）需要通过特殊机制（如管道、队列、共享内存等）。</li>
</ul>
</li>
</ul>
<p>多线程和多进程在现在计算任务中具有很重要的意义，可以很大的提升程序的运行效率。</p>
<ul>
<li><p><strong>多进程</strong>：利用多核 CPU 并行计算（如机器学习训练）。</p>
</li>
<li><p><strong>多线程</strong>：在 I&#x2F;O 等待时切换任务（如同时下载多个文件）。</p>
</li>
<li><p><strong>GUI 应用</strong>：主线程负责界面渲染，子线程处理耗时任务（避免界面卡顿）。</p>
</li>
<li><p><strong>Web 服务器</strong>：同时处理多个客户端请求。</p>
</li>
</ul>
<h3 id="Race-Condition"><a href="#Race-Condition" class="headerlink" title="Race Condition"></a>Race Condition</h3><p>但是，线程在提升效率的同时牺牲了<strong>安全性</strong>，我们来看下面的程序示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-comment"># Shared variables for threadings</span><br>balance = <span class="hljs-number">100</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">withdraw</span>(<span class="hljs-params">amount</span>):<br>    <span class="hljs-keyword">global</span> balance<br>    <span class="hljs-keyword">if</span> balance &gt;= amount:<br>        time.sleep(<span class="hljs-number">1</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Getting money..., the amount is <span class="hljs-subst">&#123;amount&#125;</span>&quot;</span>)<br>        balance -= amount<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Get <span class="hljs-subst">&#123;amount&#125;</span>, <span class="hljs-subst">&#123;balance&#125;</span> remaining...&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Error! You don&#x27;t have enough money!&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_thread_safe</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;test for race condition, safe mode for entering in queue&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;If they take turns to withdraw money at the counter in order.&quot;</span>)<br>    t1 = threading.Thread(target=withdraw, args=(<span class="hljs-number">80</span>,))<br>    t2 = threading.Thread(target=withdraw, args=(<span class="hljs-number">70</span>,))<br>    t3 = threading.Thread(target=withdraw, args=(<span class="hljs-number">50</span>,))<br>    t4 = threading.Thread(target=withdraw, args=(<span class="hljs-number">20</span>,))<br><br>    <span class="hljs-comment"># Starting multi-sessions, in queue</span><br>    t1.start()<br>    t1.join()<br>    t2.start()<br>    t2.join()<br>    t3.start()<br>    t3.join()<br>    t4.start()<br>    t4.join()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_thread_unsafe</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;test for race condition, unsafe mode for multithreads&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;If the four of them withdraw money at the counter simultaneously...&quot;</span>)<br>    t1 = threading.Thread(target=withdraw, args=(<span class="hljs-number">80</span>,))<br>    t2 = threading.Thread(target=withdraw, args=(<span class="hljs-number">70</span>,))<br>    t3 = threading.Thread(target=withdraw, args=(<span class="hljs-number">50</span>,))<br>    t4 = threading.Thread(target=withdraw, args=(<span class="hljs-number">20</span>,))<br><br>    <span class="hljs-comment"># Starting multi-sessions</span><br>    t1.start()<br>    t2.start()<br>    t3.start()<br>    t4.start()<br>    t1.join()<br>    t2.join()<br>    t3.join()<br>    t4.join()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># test for safe single-thread</span><br>    test_thread_safe()<br><br>    <span class="hljs-comment"># reset balance</span><br>    balance = <span class="hljs-number">100</span><br><br>    <span class="hljs-comment"># test for race condition: multithreads</span><br>    test_thread_unsafe()<br><br></code></pre></td></tr></table></figure>

<p>程序实现了一个简单的柜台模拟器，模拟了四个用户<strong>以不同的顺序</strong>对相同账户取钱的结果。</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-keyword">If</span> they <span class="hljs-keyword">take</span> turns <span class="hljs-keyword">to</span> withdraw money at the counter <span class="hljs-keyword">in</span> <span class="hljs-keyword">order</span>.<br>Getting money..., the amount <span class="hljs-built_in">is</span> <span class="hljs-number">80</span><br><span class="hljs-keyword">Get</span> <span class="hljs-number">80</span>, <span class="hljs-number">20</span> remaining...<br><span class="hljs-keyword">Error</span>! You don<span class="hljs-comment">&#x27;t have enough money!</span><br><span class="hljs-keyword">Error</span>! You don<span class="hljs-comment">&#x27;t have enough money!</span><br>Getting money..., the amount <span class="hljs-built_in">is</span> <span class="hljs-number">20</span><br><span class="hljs-keyword">Get</span> <span class="hljs-number">20</span>, <span class="hljs-number">0</span> remaining...<br><span class="hljs-keyword">If</span> the four <span class="hljs-keyword">of</span> them withdraw money at the counter simultaneously...<br>Getting money..., the amount <span class="hljs-built_in">is</span> <span class="hljs-number">80</span>Getting money..., the amount <span class="hljs-built_in">is</span> <span class="hljs-number">70</span><br><span class="hljs-keyword">Get</span> <span class="hljs-number">80</span>, <span class="hljs-number">20</span> remaining...<br><br><span class="hljs-keyword">Get</span> <span class="hljs-number">70</span>, -<span class="hljs-number">50</span> remaining...<br>Getting money..., the amount <span class="hljs-built_in">is</span> <span class="hljs-number">50</span><br><span class="hljs-keyword">Get</span> <span class="hljs-number">50</span>, -<span class="hljs-number">100</span> remaining...<br>Getting money..., the amount <span class="hljs-built_in">is</span> <span class="hljs-number">20</span><br><span class="hljs-keyword">Get</span> <span class="hljs-number">20</span>, -<span class="hljs-number">120</span> remaining...<br></code></pre></td></tr></table></figure>

<p>一看输出就发现了问题，在<code>unsafe_for_multithreads</code>中，钱出现了负值的情况，而并没有像第一种情况一样输出error。</p>
<h4 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h4><p>出错的核心逻辑在于<strong>在同一进程的若干个线程中</strong>，他们可以共享变量并且对这一个变量做修改，这会导致代码的逻辑错误。</p>
<p>例如上面的取钱逻辑其实就是一个<code>while</code>循环，如果四个用户一个个按顺序取钱（<strong>第二位用户不会在第一位用户取钱操作未完成的时候开始自己的取钱操作</strong>），很显然<code>balance</code>的值会被正确的更新，all is well。但是对于第二种情况，四个线程几乎同时启动（第四个线程启动的时间早于第一个线程结束的时间），这就会导致此时<code>balance -= amount</code>的核心逻辑并未执行，四个while循环全部判断为True，导致超出限额的扣款。</p>
<blockquote>
<p>这会带来很多的问题，在更复杂的函数逻辑中对变量的修改更加千变万化，出错的严重程度更高。</p>
</blockquote>
<h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h3><p>这个问题的解决方式是对程序<strong>加锁（Lock）</strong>，即强制<strong>让只有一个线程可以运行这段程序</strong>，而不允许同时运行的操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-comment"># Shared variables for threadings</span><br>balance = <span class="hljs-number">100</span><br><br><span class="hljs-comment"># lock object</span><br>lock = threading.Lock()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">withdraw_with_locked</span>(<span class="hljs-params">amount</span>):<br>    <span class="hljs-keyword">global</span> balance<br>    <span class="hljs-keyword">with</span> lock:<br>        <span class="hljs-keyword">if</span> balance &gt;= amount:<br>            time.sleep(<span class="hljs-number">1</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Getting money..., the amount is <span class="hljs-subst">&#123;amount&#125;</span>&quot;</span>)<br>            balance -= amount<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Get <span class="hljs-subst">&#123;amount&#125;</span>, <span class="hljs-subst">&#123;balance&#125;</span> remaining...&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Error! You don&#x27;t have enough money!&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_thread_unsafe_with_locked</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;test for race condition, unsafe mode for multithreads, but with lock&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;If the four of them withdraw money at the counter simultaneously..., but with lock😋!&quot;</span>)<br>    t1 = threading.Thread(target=withdraw_with_locked, args=(<span class="hljs-number">80</span>,))<br>    t2 = threading.Thread(target=withdraw_with_locked, args=(<span class="hljs-number">70</span>,))<br>    t3 = threading.Thread(target=withdraw_with_locked, args=(<span class="hljs-number">50</span>,))<br>    t4 = threading.Thread(target=withdraw_with_locked, args=(<span class="hljs-number">20</span>,))<br><br>    <span class="hljs-comment"># Starting multi-sessions</span><br>    t1.start()<br>    t2.start()<br>    t3.start()<br>    t4.start()<br>    t1.join()<br>    t2.join()<br>    t3.join()<br>    t4.join()<br><br></code></pre></td></tr></table></figure>

<p>程序的输出显示取钱的逻辑正常！</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-keyword">If</span> the four <span class="hljs-keyword">of</span> them withdraw money at the counter simultaneously..., but <span class="hljs-keyword">with</span> lock😋!<br>Getting money..., the amount <span class="hljs-built_in">is</span> <span class="hljs-number">80</span><br><span class="hljs-keyword">Get</span> <span class="hljs-number">80</span>, <span class="hljs-number">20</span> remaining...<br><span class="hljs-keyword">Error</span>! You don<span class="hljs-comment">&#x27;t have enough money!</span><br><span class="hljs-keyword">Error</span>! You don<span class="hljs-comment">&#x27;t have enough money!</span><br>Getting money..., the amount <span class="hljs-built_in">is</span> <span class="hljs-number">20</span><br><span class="hljs-keyword">Get</span> <span class="hljs-number">20</span>, <span class="hljs-number">0</span> remaining...<br></code></pre></td></tr></table></figure>

<h2 id="Lock-Again…"><a href="#Lock-Again…" class="headerlink" title="Lock Again…"></a>Lock Again…</h2><p>锁最原始的设计是非常简单粗暴的，他通过线程之间的<strong>对变量的读写权限</strong>来保证程序逻辑的正常运行，但是锁本身的设计也会带来更多的问题，下面简单介绍<strong>死锁</strong>，这一个非常经典的锁问题。</p>
<h3 id="Dead-Lock"><a href="#Dead-Lock" class="headerlink" title="Dead Lock"></a>Dead Lock</h3><p>死锁是指 <strong>多个线程&#x2F;进程因互相等待对方释放资源而无限阻塞</strong> 的情况。例如两个线程各自持有锁A和锁B，同时试图获取对方的锁。</p>
<h4 id="死锁的四个必要条件（Coffman条件）"><a href="#死锁的四个必要条件（Coffman条件）" class="headerlink" title="死锁的四个必要条件（Coffman条件）"></a>死锁的四个必要条件（Coffman条件）</h4><ol>
<li><strong>互斥条件</strong>：资源一次只能被一个线程占用。</li>
<li><strong>占有并等待</strong>：线程持有至少一个资源，并等待获取其他资源。</li>
<li><strong>非抢占条件</strong>：已分配的资源不能被强制剥夺。</li>
<li><strong>循环等待</strong>：多个线程形成环形等待链（如T1等T2，T2等T1）。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><br>lock_a = threading.Lock()<br>lock_b = threading.Lock()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">thread_1</span>():<br>    <span class="hljs-keyword">with</span> lock_a:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 1 acquired lock A&quot;</span>)<br>        <span class="hljs-keyword">with</span> lock_b:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 1 acquired lock B&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Finished!&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">thread_2</span>():<br>    <span class="hljs-keyword">with</span> lock_b:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 2 acquired lock B&quot;</span>)<br>        <span class="hljs-keyword">with</span> lock_a:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 2 acquired lock A&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Finished!&quot;</span>)<br><br><br>t1 = threading.Thread(target=thread_1)<br>t2 = threading.Thread(target=thread_2)<br>t1.start()<br>t2.start()<br>t1.join()<br>t2.join()<br><br></code></pre></td></tr></table></figure>

<p>程序在输出<code>Thread 1 acquired lock AThread 2 acquired lock B</code>之后就不再输出任何的内容，出现了卡死的情况。</p>
<p>一种比较普遍的解决办法就是<strong>设置timeout</strong>，设置等待的最大时间。（这只是保证程序不会一直卡死，并没有解决实际问题）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">thread_1_timeout</span>():<br>    <span class="hljs-keyword">if</span> lock_a.acquire(timeout=<span class="hljs-number">2</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 1 acquired lock A&quot;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> lock_b.acquire(timeout=<span class="hljs-number">2</span>):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 1 acquired lock B&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 1 finished!&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 1 could not acquire lock B, releasing lock A&quot;</span>)<br>        <span class="hljs-keyword">finally</span>:<br>            lock_a.release()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 1 could not acquire lock A&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">thread_2_timeout</span>():<br>    <span class="hljs-keyword">if</span> lock_b.acquire(timeout=<span class="hljs-number">2</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 2 acquired lock B&quot;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> lock_a.acquire(timeout=<span class="hljs-number">2</span>):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 2 acquired lock A&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 2 finished!&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 2 could not acquire lock A, releasing lock B&quot;</span>)<br>        <span class="hljs-keyword">finally</span>:<br>            lock_b.release()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Thread 2 could not acquire lock B&quot;</span>)<br><br><br>t1 = threading.Thread(target=thread_1_timeout)<br>t2 = threading.Thread(target=thread_2_timeout)<br>t1.start()<br>t2.start()<br>t1.join()<br>t2.join()<br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Thread</span> <span class="hljs-number">1</span> acquired lock AThread <span class="hljs-number">2</span> acquired lock B<br><br><span class="hljs-attribute">Thread</span> <span class="hljs-number">2</span> could not acquire lock A, releasing lock B<br><span class="hljs-attribute">Thread</span> <span class="hljs-number">1</span> acquired lock B<br><span class="hljs-attribute">Thread</span> <span class="hljs-number">1</span> finished!<br></code></pre></td></tr></table></figure>

<p>我们发现，<code>Thread 2 could not acquire lock A, releasing lock B</code>这里超时后解锁，然后这个死锁问题就被解开了。</p>
<h2 id="GIL-Global-Interpreter-Lock"><a href="#GIL-Global-Interpreter-Lock" class="headerlink" title="GIL (Global Interpreter Lock)"></a>GIL (Global Interpreter Lock)</h2><p>在现代C++中，智能指针使用<code>Reference count</code>来实现引用计数，进而自动化回收内存，但是在多线程（无锁）的情况下，很容易出现Race Condition的问题。</p>
<p>因此，GIL（Global Interpreter Lock）是 <strong>CPython 解释器</strong>（Python 官方实现）中的一个核心机制，其本质是一个 <strong>互斥锁（Mutex）</strong>，用于保证同一时刻只有一个线程可以执行 Python 字节码。它的设计初衷是 <strong>简化 CPython 的内存管理</strong>，尤其是 <strong>引用计数的线程安全</strong>。</p>
<h3 id="Impact-of-GIL"><a href="#Impact-of-GIL" class="headerlink" title="Impact of GIL"></a>Impact of GIL</h3><p>没有 GIL，Python 需要为所有数据结构（如列表、字典）实现细粒度锁，极大增加代码复杂度。而GIL非常完美的unify了这一点。同时，GIL减少了锁开销，使其在单线程中获得更好的时间性能。</p>
<p>但是GIL也有很大的限制，他会导致<strong>多核CPU的CPU密集型任务</strong>时间下降，因为GIL需要保证只有一个进程在进行Python字节码！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">count_down</span>(<span class="hljs-params">n</span>):<br>    <span class="hljs-keyword">while</span> n &gt; <span class="hljs-number">0</span>:<br>        n -= <span class="hljs-number">1</span><br><br><span class="hljs-comment"># Single-threaded execution</span><br>start_time = time.time()  <span class="hljs-comment"># Start timing</span><br>count_down(<span class="hljs-number">500_000_000</span>) <br>end_time = time.time()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Single-threaded execution time: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds&quot;</span>)<br><br><span class="hljs-comment"># Multi-threaded execution (theoretically faster, but actually slower due to GIL)</span><br>start_time = time.time()  <span class="hljs-comment"># Start timing</span><br>t1 = threading.Thread(target=count_down, args=(<span class="hljs-number">250_000_000</span>,))<br>t2 = threading.Thread(target=count_down, args=(<span class="hljs-number">250_000_000</span>,))<br>t1.start()<br>t2.start()<br>t1.join()<br>t2.join()<br>end_time = time.time()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Multi-threaded execution time: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds (due to GIL overhead)&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>例如上文的程序模拟CPU密集型任务，由于GIL强制保证<strong>只有一个线程可以执行Python字节码</strong>，这会导致<strong>伪多线程</strong>的出现：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Single-threaded execution <span class="hljs-built_in">time</span>: <span class="hljs-number">3.81</span> <span class="hljs-built_in">seconds</span><br>Multi-threaded execution <span class="hljs-built_in">time</span>: <span class="hljs-number">3.98</span> <span class="hljs-built_in">seconds</span> (due <span class="hljs-built_in">to</span> GIL overhead)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>Python 3.12 对 GIL 进行了重大改进（<a target="_blank" rel="noopener" href="https://peps.python.org/pep-0703/">PEP 703</a>），<strong>允许更细粒度的线程切换</strong>，尤其是在纯 CPU 循环中。</p>
<ul>
<li><strong>旧版本（如 Python 3.11）</strong>：GIL 导致多线程在 CPU 密集型任务中更慢。</li>
<li><strong>新版本（Python 3.12+）</strong>：GIL 的切换策略优化，使得简单循环（如 <code>n -= 1</code>）可能表现出伪并行加速。</li>
</ul>
<p>测试上文代码务必下调Python版本。</p>
</blockquote>
<p>但是，GIL只对Python字节码做了约束，<strong>在面对IO密集型</strong>的任务时多线程可以实现很大程度的加速。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">import</span> time<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cpu_task</span>(<span class="hljs-params">n: <span class="hljs-built_in">int</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;simulation of CPU intensive task</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        n (int): the total count steps</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">while</span> n &gt; <span class="hljs-number">0</span>:<br>        n -= <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;CPU task ends&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">io_task</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;simulation of IO-intensive task&quot;&quot;&quot;</span><br>    time.sleep(<span class="hljs-number">1</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_task_cpu</span>(<span class="hljs-params">task_function</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;test for GIL in CPU-intensive task&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Test for CPU-intensive task:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Test for single threaded:&quot;</span>)<br>    start_time = time.time()<br>    task_function(<span class="hljs-number">500_000_000</span>)<br>    end_time = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Single-threaded execution time: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Test for multi threaded:&quot;</span>)<br>    start_time = time.time()<br>    t1 = threading.Thread(target=task_function, args=(<span class="hljs-number">250_000_000</span>,))<br>    t2 = threading.Thread(target=task_function, args=(<span class="hljs-number">250_000_000</span>,))<br>    t1.start()<br>    t2.start()<br>    t1.join()<br>    t2.join()<br>    end_time = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Multi-threaded execution time: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_task_io</span>(<span class="hljs-params">task_function</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nTest for Io-intensive task:&quot;</span>)<br>    <span class="hljs-comment"># single threads:</span><br>    start_time = time.time()<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        io_task()<br>    end_time = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Single-threaded execution time: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds&quot;</span>)<br><br>    threads = [threading.Thread(target=io_task) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]<br>    start_time = time.time()<br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:<br>        t.start()<br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:<br>        t.join()<br>    end_time = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Multi-threaded execution time: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    test_task_cpu(cpu_task)<br>    test_task_io(io_task)<br><br></code></pre></td></tr></table></figure>

<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs subunit"><span class="hljs-keyword">Test </span>for CPU-intensive task:<br><span class="hljs-keyword">Test </span>for single threaded:<br>CPU task ends<br>Single-threaded execution time: 20.48 seconds<br><span class="hljs-keyword">Test </span>for multi threaded:<br>CPU task ends<br>CPU task ends<br>Multi-threaded execution time: 20.52 seconds<br><br><span class="hljs-keyword">Test </span>for Io-intensive task:<br>Single-threaded execution time: 10.01 seconds<br>Multi-threaded execution time: 1.01 seconds<br></code></pre></td></tr></table></figure>

<div class="note note-primary">
            <h3 id="GIL是万能的吗？"><a href="#GIL是万能的吗？" class="headerlink" title="GIL是万能的吗？"></a>GIL是万能的吗？</h3><p>GIL作为全局锁，并不是所有操作都可以被保护！例如上面的银行取款操作就不会受到GIL的保护，而需要<strong>显式同步锁</strong>才可以实现线程安全。</p><p>GIL的设计初衷就是<strong>保证引用计数的安全性</strong>，因此可以保护以下内容：</p><ol><li><strong>Python字节码执行的原子性</strong>：<ul><li>单个Python字节码指令的执行是原子的（不会被其他线程打断）</li><li>例如：<code>x = 1</code>这样的简单赋值操作是原子的</li></ul></li><li><strong>内置类型的简单操作</strong>：<ul><li>对简单数据类型（如整数、浮点数）的单个操作通常是原子的</li><li>例如：<code>x += 1</code>（如果x是整数）在Python中是原子的</li></ul></li><li><strong>解释器内部状态</strong>：<ul><li>保护<strong>CPython解释器内部数据结构</strong>不被多线程破坏</li><li>确保引用计数等机制在多线程环境下的安全</li></ul></li></ol><p>GIL<strong>不能保护的内容</strong></p><ol><li><strong>复合操作</strong>：<ul><li>需要多个步骤&#x2F;字节码的操作（如检查后修改）</li><li>例如：<code>if x &gt; 0: x -= 1</code>（检查+修改不是原子的）</li></ul></li><li><strong>I&#x2F;O操作期间</strong>：<ul><li>执行I&#x2F;O操作（如文件读写、网络请求、time.sleep）时会释放GIL</li><li>其他线程可以在I&#x2F;O操作期间执行</li></ul></li><li><strong>扩展模块中的操作</strong>：<ul><li>C扩展模块可以显式释放GIL</li><li>NumPy等科学计算库经常这样做以提高性能</li></ul></li><li><strong>应用程序级别的数据一致性</strong>：<ul><li>不保证应用程序逻辑的正确性</li><li>开发者仍需对共享数据的复合操作使用锁</li></ul></li></ol>
          </div>

<h2 id="Multi-Processing"><a href="#Multi-Processing" class="headerlink" title="Multi-Processing"></a>Multi-Processing</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><p>由于GIL的限制，Python的多线程一直被诟病成<strong>伪多线程</strong>，因为他并没有用到多核CPU的加速能力。多线程由于GIL被迫退化为阻塞的单线程，导致时间非常的慢。</p>
<p>一种常用的解决方案就是使用<strong>多进程</strong>！多进程可以绕过这个限制，因为每个进程有自己的Python解释器和内存空间，因此也有自己的GIL。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> multiprocessing<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">num</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Worker <span class="hljs-subst">&#123;num&#125;</span> running in process <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    processes = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        p = multiprocessing.Process(target=worker, args=(i,))<br>        processes.append(p)<br>        p.start()<br><br>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:<br>        p.join()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;All processes finished&quot;</span>)<br><br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Worker</span> <span class="hljs-number">0</span> running in process <span class="hljs-number">8140</span><br><span class="hljs-attribute">Worker</span> <span class="hljs-number">1</span> running in process <span class="hljs-number">8141</span><br><span class="hljs-attribute">Worker</span> <span class="hljs-number">2</span> running in process <span class="hljs-number">8142</span><br><span class="hljs-attribute">Worker</span> <span class="hljs-number">3</span> running in process <span class="hljs-number">8143</span><br><span class="hljs-attribute">Worker</span> <span class="hljs-number">4</span> running in process <span class="hljs-number">8144</span><br><span class="hljs-attribute">All</span> processes finished<br></code></pre></td></tr></table></figure>

<p>我们可以使用多进程来改写上面的CPU密集型任务，充分发挥多核CPU的优势。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">multiprocess_cpu_task</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Using multi-processing&quot;</span>)<br>    start_time = time.time()<br>    processes = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        p = multiprocessing.Process(target=cpu_task, args=(<span class="hljs-number">100_000_000</span>,))<br>        processes.append(p)<br>        p.start()<br><br>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:<br>        p.join()<br>    end_time = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;All processes finished, time: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br><br></code></pre></td></tr></table></figure>

<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs subunit"><span class="hljs-keyword">Test </span>for CPU-intensive task:<br><span class="hljs-keyword">Test </span>for single threaded:<br>CPU task ends<br>Single-threaded execution time: 23.63 seconds<br><span class="hljs-keyword">Test </span>for multi threaded:<br>CPU task ends<br>CPU task ends<br>Multi-threaded execution time: 21.67 seconds<br>Using multi-processing<br>CPU task ends<br>CPU task ends<br>CPU task ends<br>CPU task ends<br>CPU task ends<br>All processes finished, time: 4.44<br></code></pre></td></tr></table></figure>

<blockquote>
<p>使用多进程就可以绕开锁，实现多核CPU的加速！</p>
</blockquote>
<h3 id="Advanced"><a href="#Advanced" class="headerlink" title="Advanced"></a>Advanced</h3><h4 id="进程池"><a href="#进程池" class="headerlink" title="进程池"></a>进程池</h4><p>在上文中，我们使用一个列表的<code>append</code>来实现多进程的管理，我们也可以使用<strong>进程池</strong>来实现这一部分更加高效的实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Pool<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">return</span> x * x<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">with</span> Pool(processes=<span class="hljs-number">4</span>) <span class="hljs-keyword">as</span> pool: <br>        <span class="hljs-comment"># 同步执行</span><br>        result = pool.apply(worker, (<span class="hljs-number">10</span>,))<br>        <span class="hljs-built_in">print</span>(result)  <span class="hljs-comment"># 输出: 100</span><br>        <br>        <span class="hljs-comment"># 异步执行</span><br>        result = pool.apply_async(worker, (<span class="hljs-number">20</span>,))<br>        <span class="hljs-built_in">print</span>(result.get())  <span class="hljs-comment"># 输出: 400</span><br>        <br>        <span class="hljs-comment"># map方法</span><br>        results = pool.<span class="hljs-built_in">map</span>(worker, <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))<br>        <span class="hljs-built_in">print</span>(results)  <span class="hljs-comment"># 输出: [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</span><br>        <br>        <span class="hljs-comment"># imap方法(惰性求值)</span><br>        <span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> pool.imap(worker, <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)):<br>            <span class="hljs-built_in">print</span>(res)  <span class="hljs-comment"># 依次输出: 0, 1, 4, 9, 16</span><br></code></pre></td></tr></table></figure>

<ul>
<li>同步执行 和 异步执行 见下文</li>
<li>map方法表示对<code>range(10)</code>的每一个值调用函数，最后返回一个列表</li>
<li><code>imap</code>是<strong>惰性求值</strong>，最后会迭代输出每一个答案（时间更慢，但内存效率更高）</li>
</ul>
<h4 id="进程间通信-IPC"><a href="#进程间通信-IPC" class="headerlink" title="进程间通信(IPC)"></a>进程间通信(IPC)</h4><p>进程之间的GIL，内存等资源都是互相独立的，但是多进程之间也可以进行通信。</p>
<h5 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h5><p>使用队列的push和pop可以实现进程间通信：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process, Queue<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">q</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PID2: <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br>    q.put(<span class="hljs-string">&quot;Hello from child process&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Message sent from subprocess: <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    q = Queue()<br>    p = Process(target=worker, args=(q,))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PID1: <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br>    p.start()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Message received to <span class="hljs-subst">&#123;os.getpid()&#125;</span>: <span class="hljs-subst">&#123;q.get()&#125;</span>&quot;</span>)<br>    p.join()<br><br></code></pre></td></tr></table></figure>

<h5 id="Pipe"><a href="#Pipe" class="headerlink" title="Pipe"></a>Pipe</h5><p>在CLI中非常好用，在本质上<strong>也是一种多进程通信</strong>的手段。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process, Queue, Pipe<br><span class="hljs-keyword">import</span> multiprocessing<br><span class="hljs-keyword">import</span> multiprocessing.connection<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker_queue</span>(<span class="hljs-params">q: Queue</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PID2: <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br>    q.put(<span class="hljs-string">&quot;Hello from child process&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Message sent from subprocess: <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker_pipe</span>(<span class="hljs-params">conn: multiprocessing.connection.Connection</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PID2: <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br>    conn.send(<span class="hljs-string">&quot;Message from child&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Message sent from subprocess: <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br>    conn.close()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_pipe</span>():<br>    parent_conn, child_conn = Pipe()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PID1: <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br>    p = Process(target=worker_pipe, args=(child_conn,))<br>    p.start()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Message received to <span class="hljs-subst">&#123;os.getpid()&#125;</span>: <span class="hljs-subst">&#123;parent_conn.recv()&#125;</span>&quot;</span>)<br>    p.join()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_queue</span>():<br>    q = Queue()<br>    p = Process(target=worker_queue, args=(q,))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PID1: <span class="hljs-subst">&#123;os.getpid()&#125;</span>&quot;</span>)<br>    p.start()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Message received to <span class="hljs-subst">&#123;os.getpid()&#125;</span>: <span class="hljs-subst">&#123;q.get()&#125;</span>&quot;</span>)<br>    p.join()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    test_pipe()<br>    test_queue()<br><br></code></pre></td></tr></table></figure>

<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">PID1:</span> <span class="hljs-number">14515</span><br><span class="hljs-symbol">PID2:</span> <span class="hljs-number">14516</span><br>Message sent <span class="hljs-keyword">from</span> subprocess: <span class="hljs-number">14516</span><br>Message received <span class="hljs-keyword">to</span> <span class="hljs-number">14515</span>: Message <span class="hljs-keyword">from</span> child<br><span class="hljs-symbol">PID1:</span> <span class="hljs-number">14515</span><br><span class="hljs-symbol">PID2:</span> <span class="hljs-number">14517</span><br>Message sent <span class="hljs-keyword">from</span> subprocess: <span class="hljs-number">14517</span><br>Message received <span class="hljs-keyword">to</span> <span class="hljs-number">14515</span>: Hello <span class="hljs-keyword">from</span> child process<br></code></pre></td></tr></table></figure>

<p>也可以使用：</p>
<ul>
<li><strong>Value&#x2F;Array</strong>: 用于共享基本数据类型</li>
<li><strong>Manager</strong>: 可以创建共享的复杂数据结构(如字典、列表)</li>
</ul>
<p>来实现内存内容的共享（对于更加复杂的数据结构），这里不详细展开。</p>
<h2 id="asyncio"><a href="#asyncio" class="headerlink" title="asyncio"></a><code>asyncio</code></h2><p>异步编程是一种 <strong>非阻塞式并发模型</strong>，核心思想是 <strong>在等待I&#x2F;O操作（如网络请求、文件读写）时释放CPU资源</strong>，让程序可以同时处理其他任务，从而提升效率。它是现代高并发程序（如Web服务器、爬虫）的核心技术之一。</p>
<blockquote>
<p>异步适合于<strong>IO密集型任务</strong>而非<strong>CPU密集型任务</strong>。</p>
</blockquote>
<h3 id="同步和异步编程"><a href="#同步和异步编程" class="headerlink" title="同步和异步编程"></a>同步和异步编程</h3><p>面对IO密集型任务，程序需要耗费很多时间进行IO操作的等待，例如等待用户的输入或者文件读写，获取请求等等，这成为了程序运行的时间瓶颈。在同步编程中，<strong>每个操作必须完成后才能执行下一个操作</strong>。<strong>异步编程</strong>是一种非阻塞的编程范式，它允许程序在等待I&#x2F;O操作（如网络请求、文件读写等）完成时继续执行其他任务，而不是干等着。</p>
<h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><ol>
<li><strong>事件循环 (Event Loop)</strong>:<ul>
<li>异步编程的核心，负责调度和执行协程</li>
<li>不断检查哪些协程可以继续执行</li>
<li>处理I&#x2F;O事件和回调</li>
</ul>
</li>
<li><strong>协程 (Coroutine)</strong>:<ul>
<li>可暂停和恢复的函数（就是<strong>需要IO密集等待的函数</strong>）</li>
</ul>
</li>
<li><strong>Future&#x2F;Task</strong>:<ul>
<li>Future表示异步操作的最终结果</li>
<li>Task是Future的子类，用于包装和管理协程的执行</li>
</ul>
</li>
</ol>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><ol>
<li>程序启动<strong>事件循环</strong></li>
<li>将协程注册为任务加入事件循环</li>
<li>遇到I&#x2F;O操作时，<strong>协程暂停并释放控制权</strong></li>
<li>事件循环执行其他可运行的任务</li>
<li>I&#x2F;O操作完成后，事件循环恢复暂停的协程</li>
<li>重复上述过程直到所有任务完成</li>
</ol>
<h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><h4 id="Example1-Fetching-Urls"><a href="#Example1-Fetching-Urls" class="headerlink" title="Example1: Fetching Urls."></a>Example1: Fetching Urls.</h4><blockquote>
<p>Talk is cheap! Just show you my code.</p>
</blockquote>
<p>我们这里模拟客户端的行为，使用<code>requests</code>库来进行对三个网站的访问，统计<strong>非并发（同步编程）</strong>和<strong>异步编程（并发）</strong>的速度差异。同时，我们可以使用<code>aiohttp</code>来实现异步的http请求。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> aiohttp<br><br>urls = [<br>    <span class="hljs-string">&quot;https://github.com&quot;</span>,<br>    <span class="hljs-string">&quot;https://sjtu.edu.cn&quot;</span>,<br>    <span class="hljs-string">&quot;https://acm.sjtu.edu.cn/OnlineJudge/&quot;</span>,<br>    <span class="hljs-string">&quot;https://chat.deepseek.com/&quot;</span>,<br>    <span class="hljs-string">&quot;https://www.bilibili.com/&quot;</span>,<br>    <span class="hljs-string">&quot;https://stackoverflow.com/questions&quot;</span><br>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_url_simple</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">try</span>:<br>        response = requests.get(url, timeout=<span class="hljs-number">10</span>)  <span class="hljs-comment"># 设置超时时间为 10 秒</span><br>        <span class="hljs-keyword">return</span> response.text<br>    <span class="hljs-keyword">except</span> requests.exceptions.Timeout:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Timeout occurred while fetching <span class="hljs-subst">&#123;url&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">except</span> requests.exceptions.ConnectionError <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Connection error occurred: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;An error occurred: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_for_simple</span>():<br>    <span class="hljs-comment"># Using the for-loop</span><br>    <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls:<br>        content = fetch_url_simple(url)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;url&#125;</span> returns <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(content)&#125;</span> bytes&quot;</span>)<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_url</span>(<span class="hljs-params">url</span>):<br>    timeout = aiohttp.ClientTimeout(total=<span class="hljs-number">10</span>)  <span class="hljs-comment"># 设置超时时间为 10 秒</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession(timeout=timeout) <span class="hljs-keyword">as</span> session:<br>            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url) <span class="hljs-keyword">as</span> response:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.text()<br>    <span class="hljs-keyword">except</span> asyncio.TimeoutError:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Timeout occurred while fetching <span class="hljs-subst">&#123;url&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_for_concurrency</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;: The test for fetching urls: test for concurrency&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Task list</span><br>    tasks = [fetch_url(url) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls]<br><br>    <span class="hljs-comment"># For all tasks: Concurrency</span><br>    results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)<br><br>    <span class="hljs-keyword">for</span> url, content <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(urls, results):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;url&#125;</span> returns <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(content)&#125;</span> bytes&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    start_time = time.time()<br>    asyncio.run(test_for_concurrency())<br>    end_time = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Total time for concurrency: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds&quot;</span>)<br><br>    start_time = time.time()<br>    test_for_simple()<br>    end_time = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Total time for no concurrency: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds&quot;</span>)<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>这里只是最简单的网站请求模拟，很多网站<strong>会对高并发的网络请求行为</strong>做出限制（比如github pages，甚至不可以ping😅），可以选择一些比较大的网站。</p>
</blockquote>
<p>输出：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">https:</span><span class="hljs-comment">//github.com returns 282454 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//sjtu.edu.cn returns 69499 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//acm.sjtu.edu.cn/OnlineJudge/ returns 6467 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//chat.deepseek.com/ returns 2024 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//www.bilibili.com/ returns 1824 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//stackoverflow.com/questions returns 6994 bytes</span><br>Total time for concurrency: <span class="hljs-number">0.62</span> seconds<br><span class="hljs-symbol">https:</span><span class="hljs-comment">//github.com returns 282453 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//sjtu.edu.cn returns 69499 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//acm.sjtu.edu.cn/OnlineJudge/ returns 6467 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//chat.deepseek.com/ returns 2023 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//www.bilibili.com/ returns 1886 bytes</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//stackoverflow.com/questions returns 6994 bytes</span><br>Total time for no concurrency: <span class="hljs-number">2.71</span> seconds<br></code></pre></td></tr></table></figure>

<h4 id="Example2-Simulation-of-User-I-O"><a href="#Example2-Simulation-of-User-I-O" class="headerlink" title="Example2: Simulation of User I&#x2F;O"></a>Example2: Simulation of User I&#x2F;O</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> random<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">user_io_simulation</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;Use time.sleep to simulate the wait for user input&quot;&quot;&quot;</span><br>    time.sleep(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">return</span> random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">simulation</span>():<br>    total = <span class="hljs-number">100</span><br>    <span class="hljs-keyword">while</span> total &gt; <span class="hljs-number">0</span>:<br>        total -= <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> total % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">input</span> = user_io_simulation()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;User enters the input <span class="hljs-subst">&#123;<span class="hljs-built_in">input</span>&#125;</span>&quot;</span>)<br>            total -= <span class="hljs-built_in">input</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Now the total value is <span class="hljs-subst">&#123;total&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done!&quot;</span>)<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">user_io_simulation_2</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;Simulation with async</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Returns:</span><br><span class="hljs-string">        int: The user input</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">return</span> random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">simulation_concurrency</span>():<br>    total = <span class="hljs-number">100</span><br>    tasks = []  <span class="hljs-comment"># List to store tasks</span><br>    <span class="hljs-keyword">while</span> total &gt; <span class="hljs-number">0</span>:<br>        total -= <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> total % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># Create a task for user input simulation</span><br>            task = asyncio.create_task(user_io_simulation_2())<br>            tasks.append(task)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Now the total value is: <span class="hljs-subst">&#123;total&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># Wait for all tasks to complete</span><br>    results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)<br>    <span class="hljs-keyword">for</span> user_input <span class="hljs-keyword">in</span> results:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;User enters the input: <span class="hljs-subst">&#123;user_input&#125;</span>&quot;</span>)<br>        total -= user_input<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done!&quot;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">await</span> simulation_concurrency()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Testing simulation for no concurrency&quot;</span>)<br>    start_time = time.time()<br>    simulation()<br>    end_time = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Time cost: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Testing simulation for concurrency&quot;</span>)<br>    start_time = time.time()<br>    asyncio.run(main())<br>    end_time = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Time cost: <span class="hljs-subst">&#123;end_time - start_time:<span class="hljs-number">.2</span>f&#125;</span> seconds&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>程序的输出：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Testing</span> simulation for no concurrency<br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">99</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">98</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">97</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">96</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">95</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">94</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">93</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">92</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">91</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">90</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">89</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">88</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">87</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">86</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">85</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">84</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">83</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">82</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">81</span><br><span class="hljs-attribute">User</span> enters the input <span class="hljs-number">1</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">79</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">78</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">77</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">76</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">75</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">74</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">73</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">72</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">71</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">70</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">69</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">68</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">67</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">66</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">65</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">64</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">63</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">62</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">61</span><br><span class="hljs-attribute">User</span> enters the input <span class="hljs-number">3</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">57</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">56</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">55</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">54</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">53</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">52</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">51</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">50</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">49</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">48</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">47</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">46</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">45</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">44</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">43</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">42</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">41</span><br><span class="hljs-attribute">User</span> enters the input <span class="hljs-number">4</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">36</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">35</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">34</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">33</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">32</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">31</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">30</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">29</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">28</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">27</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">26</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">25</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">24</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">23</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">22</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">21</span><br><span class="hljs-attribute">User</span> enters the input <span class="hljs-number">4</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">16</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">15</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">14</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">13</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">12</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">11</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">10</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">9</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">8</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">7</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">6</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">5</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">4</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">3</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">2</span><br><span class="hljs-attribute">Now</span> the total value is <span class="hljs-number">1</span><br><span class="hljs-attribute">User</span> enters the input <span class="hljs-number">2</span><br><span class="hljs-attribute">Now</span> the total value is -<span class="hljs-number">2</span><br><span class="hljs-attribute">Done</span>!<br><span class="hljs-attribute">Time</span> cost: <span class="hljs-number">10</span>.<span class="hljs-number">76</span> seconds<br><span class="hljs-attribute">Testing</span> simulation for concurrency<br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">99</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">98</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">97</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">96</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">95</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">94</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">93</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">92</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">91</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">90</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">89</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">88</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">87</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">86</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">85</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">84</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">83</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">82</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">81</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">80</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">79</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">78</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">77</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">76</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">75</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">74</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">73</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">72</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">71</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">70</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">69</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">68</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">67</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">66</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">65</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">64</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">63</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">62</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">61</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">60</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">59</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">58</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">57</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">56</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">55</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">54</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">53</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">52</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">51</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">50</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">49</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">48</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">47</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">46</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">45</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">44</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">43</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">42</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">41</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">40</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">39</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">38</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">37</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">36</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">35</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">34</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">33</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">32</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">31</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">30</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">29</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">28</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">27</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">26</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">25</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">24</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">23</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">22</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">21</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">20</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">19</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">18</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">17</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">16</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">15</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">14</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">13</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">12</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">11</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">10</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">9</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">8</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">7</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">6</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">5</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">4</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">3</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">2</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">1</span><br><span class="hljs-attribute">Now</span> the total value is: <span class="hljs-number">0</span><br><span class="hljs-attribute">User</span> enters the input: <span class="hljs-number">2</span><br><span class="hljs-attribute">User</span> enters the input: <span class="hljs-number">3</span><br><span class="hljs-attribute">User</span> enters the input: <span class="hljs-number">4</span><br><span class="hljs-attribute">User</span> enters the input: <span class="hljs-number">3</span><br><span class="hljs-attribute">User</span> enters the input: <span class="hljs-number">1</span><br><span class="hljs-attribute">Done</span>!<br><span class="hljs-attribute">Time</span> cost: <span class="hljs-number">2</span>.<span class="hljs-number">01</span> seconds<br></code></pre></td></tr></table></figure>

<p>在<strong>异步</strong>的版本中，用户的输出（阻塞的IO操作）被加入了一个task列表中，在输出中也可以看见<strong>用户的输出后于其他程序逻辑执行</strong>，因此盲目的使用<strong>异步编程</strong>也可能会导致代码逻辑的错乱，必须要谨慎使用。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Project/" class="category-chain-item">Project</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Finished/" class="print-no-link">#Finished</a>
      
        <a href="/tags/Python/" class="print-no-link">#Python</a>
      
        <a href="/tags/Tutorial/" class="print-no-link">#Tutorial</a>
      
        <a href="/tags/GIL/" class="print-no-link">#GIL</a>
      
        <a href="/tags/Threadings/" class="print-no-link">#Threadings</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Python Threadings</div>
      <div>https://xiyuanyang-code.github.io/posts/Python-Threadings/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Xiyuan Yang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>May 1, 2025</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Updated on</div>
          <div>May 2, 2025</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/AINN-Transformer/" title="AINN Transformer">
                        <span class="hidden-mobile">AINN Transformer</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"xiyuanyang-code/xiyuanyang-code.github.io","repo-id":"R_kgDONRhvHQ","category":"Announcements","category-id":"DIC_kwDONRhvHc4ClBnp","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://github.com/xiyuanyang-code" target="_blank" rel="nofollow noopener"><span>YXY</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/Siyan-Li" target="_blank" rel="nofollow noopener"><span>LSY</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
